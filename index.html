<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Dual N-Back Pro V6 (Synced)</title>
<style>
:root{--bg:#121212;--fg:#e0e0e0;--p:#2196F3;--s:#4CAF50;--d:#333;--g:#FFD700}
body{margin:0;overflow:hidden;background:var(--bg);color:var(--fg);font-family:monospace;height:100dvh;display:flex;flex-direction:column;user-select:none;-webkit-user-select:none}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.96);display:flex;flex-direction:column;place-content:center;align-items:center;gap:15px;z-index:100;transition:opacity 0.2s}
.setting-row{display:flex;align-items:center;justify-content:space-between;gap:20px;font-size:1.2rem;width:220px}
input[type=number]{background:#333;border:1px solid #555;color:#fff;font-size:1.2rem;padding:5px;width:60px;text-align:center;border-radius:6px}
#final-score{font-size:2rem;color:var(--p);margin-bottom:10px;display:none}
#leaderboard{background:#1e1e1e;padding:15px;border-radius:10px;width:280px;border:1px solid #333;margin-top:10px}
.lb-title{text-align:center;color:var(--g);font-weight:bold;margin-bottom:10px;border-bottom:1px solid #444;padding-bottom:5px}
.lb-row{display:flex;justify-content:space-between;font-size:1rem;padding:4px 0}
#start{padding:15px 50px;font-size:1.5rem;background:var(--p);color:#fff;border:0;border-radius:8px;font-weight:bold;cursor:pointer;margin-top:10px}
#stats{padding:15px;display:grid;grid-template-columns:1fr 1fr 1fr;text-align:center;font-size:1.2rem;background:#1e1e1e;border-bottom:1px solid #333}
#game{flex:1;display:flex;place-content:center;place-items:center;position:relative}
#grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:min(90vw,50vh);aspect-ratio:1}
.cell{background:var(--d);border-radius:4px;transition:background 0.1s ease-out}
.active{background:var(--p)!important;box-shadow:0 0 15px var(--p)}
#controls{padding:20px;display:grid;grid-template-columns:1fr 1fr;gap:20px;height:20vh}
.btn{background:#1e1e1e;color:var(--fg);border:2px solid #333;border-radius:12px;font-size:1.2rem;display:grid;place-items:center;transition:all 0.1s}
.btn:active{background:#333;transform:scale(0.98)}
.btn.disabled{opacity:0.3;pointer-events:none;border-color:#222}
.btn-success{background-color:var(--s)!important;color:#fff!important;border-color:var(--s)!important;box-shadow:0 0 15px var(--s)}
#flash{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .2s;z-index:50}
.bad{background:rgba(244,67,54,.4)}
</style>
</head>
<body>
<div id="flash"></div>

<div id="overlay">
    <div id="final-score">SCORE: <span id="end-score-val">0</span></div>
    
    <div class="setting-row">
        <label>N-Level:</label>
        <input type="number" id="n-input" value="2" min="1" max="9" onchange="renderLB()">
    </div>
    <div class="setting-row">
        <label>Time (s):</label>
        <input type="number" id="time-input" value="30" min="10" max="300">
    </div>

    <div id="leaderboard">
        <div class="lb-title">TOP SCORES (N-<span id="lb-n">2</span>)</div>
        <div id="lb-list"></div>
    </div>
    
    <button id="start">START GAME</button>
</div>

<div id="stats">
    <span style="text-align:left">N: <b id="n-display">2</b></span>
    <span>Time: <b id="time-display">30</b></span>
    <span style="text-align:right">Score: <b id="score">0</b></span>
</div>

<div id="game"><div id="grid"></div></div>

<div id="controls">
    <button class="btn disabled" id="btn-a">Audio Match (A)</button>
    <button class="btn disabled" id="btn-p">Position Match (L)</button>
</div>

<script>
const G=document.getElementById('grid'),
      S=document.getElementById('score'),
      T_DISP=document.getElementById('time-display'),
      N_DISP=document.getElementById('n-display'),
      F=document.getElementById('flash'),
      OVERLAY=document.getElementById('overlay'),
      END_SCORE=document.getElementById('end-score-val'),
      FINAL_SCORE_DIV=document.getElementById('final-score'),
      LB_LIST=document.getElementById('lb-list'),
      LB_N=document.getElementById('lb-n'),
      BTNS={a:document.getElementById('btn-a'),p:document.getElementById('btn-p')},
      LETTERS=['A','B','C','H','K','L','M','O','P','T'];

let state={n:2,hist:[],score:0,active:false,input:{a:false,p:false},timer:null, gameTimer:null, timeLeft:30},
    audCache={}, synth=window.speechSynthesis, selectedVoice=null;

// Setup Grid
for(let i=0;i<9;i++)G.appendChild(document.createElement('div')).className='cell';
const cells=G.children;

// Audio Setup
function selectVoice() {
    const voices = synth.getVoices();
    selectedVoice = voices.find(v => v.name.includes("Google US English")) || 
                    voices.find(v => v.name.includes("Zira")) ||
                    voices.find(v => v.lang === "en-US") || 
                    voices[0];
}
if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = selectVoice;
}

const loadAud=()=>{
    selectVoice();
    LETTERS.forEach(x=>{
        audCache[x] = new SpeechSynthesisUtterance(x);
        audCache[x].voice = selectedVoice;
        audCache[x].lang = 'en-US';
        audCache[x].rate = 1.1;
        audCache[x].pitch = 1.2;
    });
};

const rng=m=>{let a=new Uint32Array(1);crypto.getRandomValues(a);return a[0]%m};
const flash=c=>{F.className=c;F.style.opacity=1;setTimeout(()=>F.style.opacity=0,200)};

// --- Leaderboard ---
function saveScore(n, score) {
    if(score === 0) return;
    let key = `dnb_scores_n${n}`;
    let scores = JSON.parse(localStorage.getItem(key) || '[]');
    let date = new Date().toLocaleDateString(undefined, {month:'numeric', day:'numeric'});
    scores.push({s: score, d: date});
    scores.sort((a,b) => b.s - a.s);
    scores = scores.slice(0, 5);
    localStorage.setItem(key, JSON.stringify(scores));
}

function renderLB() {
    let n = parseInt(document.getElementById('n-input').value) || 2;
    LB_N.textContent = n;
    let scores = JSON.parse(localStorage.getItem(`dnb_scores_n${n}`) || '[]');
    LB_LIST.innerHTML = scores.length 
        ? scores.map((x,i) => `<div class="lb-row"><span>#${i+1} ${x.d}</span><span>${x.s}</span></div>`).join('')
        : '<div class="lb-row" style="justify-content:center;color:#666">- No Records -</div>';
}

// --- Game Logic ---
function endGame(){
    state.active = false;
    clearTimeout(state.timer);
    clearInterval(state.gameTimer);
    saveScore(state.n, state.score);
    renderLB();
    END_SCORE.textContent = state.score;
    FINAL_SCORE_DIV.style.display = 'block';
    OVERLAY.style.display = 'flex';
    document.getElementById('start').textContent = "PLAY AGAIN";
}

function updateGameTimer(){
    state.timeLeft--;
    T_DISP.textContent = state.timeLeft;
    if(state.timeLeft <= 0) endGame();
}

function turn(){
    if(!state.active) return;
    const len = state.hist.length;
    
    // Check misses
    if(len > state.n){
        const prev = state.hist[len-1-state.n], curr = state.hist[len-1];
        if(!state.input.a && prev.l === curr.l) { state.score -= 50; flash('bad'); }
        if(!state.input.p && prev.p === curr.p) { state.score -= 50; flash('bad'); }
    }
    S.textContent = state.score;
    state.input = {a:false, p:false};
    
    const canMatch = len >= state.n;
    BTNS.a.className = canMatch ? 'btn' : 'btn disabled';
    BTNS.p.className = canMatch ? 'btn' : 'btn disabled';

    let p = (canMatch && Math.random()<0.3) ? state.hist[len-state.n].p : rng(9);
    let l = (canMatch && Math.random()<0.3) ? state.hist[len-state.n].l : LETTERS[rng(10)];

    state.hist.push({p, l});

    // --- SYNCHRONIZATION FIX ---
    // 1. Trigger Audio IMMEDIATELY
    if(audCache[l]) synth.speak(audCache[l]);
    else { 
        let u=new SpeechSynthesisUtterance(l); 
        u.voice = selectedVoice; u.rate=1.1; u.pitch=1.2; 
        synth.speak(u); 
    }

    // 2. Trigger Visual after 100ms (Audio Latency Compensation)
    setTimeout(() => {
        if(!state.active) return; // Edge case: if game ended during delay
        cells[p].classList.add('active');
        setTimeout(()=>cells[p].classList.remove('active'), 800);
    }, 100); 

    state.timer = setTimeout(turn, 3000);
}

function check(type){
    if(!state.active || state.hist.length <= state.n || state.input[type]) return;
    state.input[type] = true;
    const btn = BTNS[type];
    const idx = state.hist.length - 1;
    const match = type==='a' ? state.hist[idx].l===state.hist[idx-state.n].l 
                           : state.hist[idx].p===state.hist[idx-state.n].p;
    
    if(match){ 
        state.score += 100; 
        btn.classList.add('btn-success');
        setTimeout(()=>btn.classList.remove('btn-success'), 300);
    } else { 
        state.score -= 50; 
        flash('bad'); 
    }
    S.textContent = state.score;
}

function startGame(){
    state.n = parseInt(document.getElementById('n-input').value) || 2;
    state.timeLeft = parseInt(document.getElementById('time-input').value) || 30;
    
    N_DISP.textContent = state.n;
    T_DISP.textContent = state.timeLeft;
    FINAL_SCORE_DIV.style.display = 'none';
    OVERLAY.style.display = 'none';
    BTNS.a.className = 'btn disabled';
    BTNS.p.className = 'btn disabled';
    
    if(synth.speaking) synth.cancel();
    loadAud();
    
    state.active = true;
    state.hist = [];
    state.score = 0;
    S.textContent = 0;
    
    state.gameTimer = setInterval(updateGameTimer, 1000);
    turn();
}

const bind=(id, fn)=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('pointerdown', e=>{e.preventDefault(); fn()});
};
bind('start', startGame);
bind('btn-a', ()=>check('a'));
bind('btn-p', ()=>check('p'));

window.addEventListener('keydown', e=>{
    if(e.repeat) return;
    if(e.key.toLowerCase()==='a') check('a');
    if(e.key.toLowerCase()==='l') check('p');
});

renderLB();
selectVoice();
</script>
</body>
</html>